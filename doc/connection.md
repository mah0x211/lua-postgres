# postgres.connection

defined in [postgres.connection](../lib/connection.lua) module.


## conn, err, timeout = connection.new( [conninfo] )

connect to the server.

**Parameters**

- `conninfo:string`: connection uri string. see [libpq documentation: 34.1.1. Connection Strings](https://www.postgresql.org/docs/current/libpq-connect.html#LIBPQ-CONNSTRING-URIS) for details. if not specified, [libpq documentation: 34.15. Environment Variables](https://www.postgresql.org/docs/current/libpq-envars.html) is used.

**Returns**

- `ok:boolean`: `true` on success.
- `err:any`: error message.
- `timeout:boolean`: `true` if timeout.


## ok, err, timeout = connection:close( force )

send the `Terminate` message to the server and close the connection.

**Parameters**

- `force:boolean`: if `true` is passed, the connection is closed immediately without sending the terminate message.

**Returns**

- `ok:boolean`: `true` on success.
- `err:any`: error message.
- `timeout:boolean`: `true` if timeout.


## ok = connection:is_connected()

check if the connection is open.

**Returns**

- `ok:boolean`: `true` if the connection is open.


## conninfo = connection:get_conninfo()

get the connection uri string.

**Returns**

- `conninfo:string`: connection uri string.


## cancel, err = connection:get_cancel()

get the [postgres.canceler](canceler.md) object.

**Returns**

- `cancel:postgres.canceler`: `postgres.canceler` object.
- `err:any`: the error object.


## status? = connection:status()

get the connection status. it returns the `nil` if the connection is not open or connection is not ready for a new query cycle.

**Returns**

- `status:string`: the following values are possible:
    - `"idle"`: not in a transaction block.
    - `"transaction"`: in a transaction block.
    - `"failed_transaction"`: in a failed transaction block. (queries will be rejected until block is ended)


## value = connection:parameter_status( param_name )

get the current parameter setting of the server.

see [55.2.7. Asynchronous Operations ](https://www.postgresql.org/docs/current/protocol-flow.html#PROTOCOL-ASYNC) for details.

**Parameters**

- `param_name:string`: parameter name.

**Returns**

- `value:string`: parameter value.


## version = connection:server_version()

get the version of the server.

equivalent to `connection:parameter_status('server_version')`.


## encoding = connection:client_encoding()

get the client encoding.

equivalent to `connection:parameter_status('client_encoding')`.


## errmsg = connection:error_message()

get the error message most recently generated by an operation on the connection.

**Returns**

- `errmsg:postgres.message.error_response`: error message.


## pid = connection:backend_pid()

get the process ID (PID) of the backend server process for this connection.

see [libpq documentation: 33.20. PQbackendPID](https://www.postgresql.org/docs/current/libpq-status.html#LIBPQ-PQBACKENDPID) for details.

**Returns**

- `pid:integer`: backend PID.


## connection:set_notice_receiver( noticefn )

set a callback to notice when the server reports a notice or warning message.  
if `nil` is passed, the default notice function is used.

**Parameters**

- `noticefn:function`: notice function as the following signature;  
    ```lua
    --- notice function
    --- @param msg postgres.message.error_response
    function noticefn( msg )
        --- do something
    end
    ```


## oldfn = connection:trace( tracefn )

set a callback to trace client/server communication.  
if `nil` is passed, tracing is disabled.

**Parameters**

- `tracefn:function`: trace function as the following signature;  
    ```lua
    --- trace function
    --- @param from string "client" or "server"
    --- @param msg string protocol message string
    function tracefn( from, msg:string )
        --- do something
    end
    ```

**Returns**

- `oldfn:function`: the previous trace function.


## ok, err, timeout = connection:flush()

send the flush message to the server.

see [55.2.3. Extended Query](https://www.postgresql.org/docs/current/protocol-flow.html#PROTOCOL-FLOW-EXT-QUERY) for details.

**Returns**

- `ok:boolean`: `true` if the flush message was sent successfully.
- `err:any`: the error object.
- `timeout:boolean`: `true` if the operation would block.


## qry, err, params = connection:replace_named_params( qry, params )

converts a named parameter `${NAME}` in an SQL query to a positional parameter `$<digit>` and returns the converted SQL query and parameter array.

**Parameters**

- `qry:string`: the SQL query.
- `params:table`: the parameters.

**Returns**

- `qry:string`: the SQL query with the named parameters replaced with the corresponding values.
- `err:any`: the error object.
- `params:table`: the parameters.

**Example**

```lua
local dump = require('dump')
local conn = require('postgres.connection').new()
local qry, err, params = conn:replace_named_params([[
    SELECT
        *
    FROM
        users
    WHERE
        name = ${name}
    AND
        age in (${age})
]], {
    name = "John",
    age = {
        20,
        30,
    },
})

print(qry)
-- SELECT
--     *
-- FROM
--     users
-- WHERE
--     name = $1
-- AND
--     age in ($2, $3)

print(dump(params))
-- {
--     [1] = "John",
--     [2] = "20",
--     [3] = "30"
-- }
```


## msg, err, timeout = connection:query( qry [, params [, max_rows]] )

executes an SQL query and returns the result.  
before executing the query, the named parameters in the query are replaced with positional parameters with `connection:replace_named_params()` method.

**Parameters**

- `qry:string`: the SQL query.
- `params:table`: the parameters.
- `max_rows:integer`: the maximum number of rows to return. if `nil` is passed, all rows are returned.

**Returns**

- `msg:postgres.message?`: the message object.
- `err:any`: the error object.
- `timeout:boolean`: `true` if the operation would block.


## msg, err, timeout = connection:next()

retrieves a message from the server.

if you sent a query message, you must retrieve the response message from the server until it returns a `ReadyForQuery` message.

this method will return the `postgres.message` object except the following message types:

- `DataRow`
- `CloseComplete`
- `NoticeResponse`

**Returns**

- `msg:postgres.message`: the message object.
- `err:any`: the error object.
- `timeout:boolean`: `true` if the operation would block.

