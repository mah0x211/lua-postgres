# postgres.connection

defined in [postgres.connection](../lib/connection.lua) module.


## conn, err, timeout = connection.new( [conninfo] [, sec] )

connect to the server.

**Parameters**

- `conninfo:string`: connection string. see [libpq documentation: 34.1.1. Connection Strings](https://www.postgresql.org/docs/current/libpq-connect.html#LIBPQ-CONNSTRING) for details. if not specified, [libpq documentation: 34.15. Environment Variables](https://www.postgresql.org/docs/current/libpq-envars.html) is used.
- `sec:number`: timeout in seconds.

**Returns**

- `ok:boolean`: `true` on success.
- `err:any`: error message.
- `timeout:boolean`: `true` if timeout.


## connection:close()

close the connection.


## cancel, err = connection:get_cancel()

get the [postgres.pgcancel](pgcancel.md) object.

**Returns**

- `cancel:libpq.cancel`: `libpq.cancel` object.
- `err:any`: error message.


## ok, err = connection:request_cancel()

request cancel the current query to the server.

**Returns**

- `ok:boolean`: `true` on success.
- `err:any`: error message, or `nil` if the cancel request is sent successfully.


## status = connection:status()

get the connection status.

see [libpq documentation: 33.14. PQstatus](https://www.postgresql.org/docs/current/libpq-status.html#LIBPQ-PQSTATUS) for details.

**Returns**

- `status:string`: the following values are possible:
    - `"ok"`: connection is ready.
    - `"bad"`: connection is bad.
    - `"started"`: waiting for connection to be made.
    - `"made"`: connection OK; waiting to send.
    - `"awaiting_response"`: waiting for a response from the server.
    - `"auth_ok"`: received authentication; waiting for backend start-up to finish.
    - `"setenv"`: this state is no longer used.
    - `"ssl_startup"`: negotiating SSL.
    - `"needed"`: internal state: connect() needed.
    - `"check_writable"`: checking if session is read-write.
    - `"consume"`: consuming any extra messages.
    - `"gss_startup"`: negotiating GSSAPI.
    - `"check_target"`: checking target server properties.
    - `"check_standby"`: checking if server is in standby mode.
    - `"unknown ConnStatusType"`: unknown status type. (should not happen)


## status = connection:transaction_status()

get the transaction status.

see [libpq documentation: 33.15. PQtransactionStatus](https://www.postgresql.org/docs/current/libpq-status.html#LIBPQ-PQTRANSACTIONSTATUS) for details.

**Returns**

- `status:sting`: the following values are possible:
    - `"idle"`: connection idle.
    - `"active"`: command in progress.
    - `"intrans`": idle, within transaction block.
    - `"inerror"`: idle, within failed transaction.
    - `"unknown"`: cannot determine status.
    - `"unknown TransactionStatusType"`: unknown status type. (should not happen)


## status = connection:parameter_status( param_name )

get the current parameter setting of the server.

see [libpq documentation: 33.16. PQparameterStatus](https://www.postgresql.org/docs/current/libpq-status.html#LIBPQ-PQPARAMETERSTATUS) for details.

**Parameters**

- `param_name:string`: parameter name.

**Returns**

- `status:string`: parameter value.


## version = connection:protocol_version()

get the version of the connection protocol being used.

see [libpq documentation: 33.17. PQprotocolVersion](https://www.postgresql.org/docs/current/libpq-status.html#LIBPQ-PQPROTOCOLVERSION) for details.

**Returns**

- `version:integer`: protocol version.


## version = connection:server_version()

get the version of the server.

see [libpq documentation: 33.18. PQserverVersion](https://www.postgresql.org/docs/current/libpq-status.html#LIBPQ-PQSERVERVERSION) for details.

**Returns**

- `version:integer`: server version.


## errmsg = connection:error_message()

get the error message most recently generated by an operation on the connection.

see [libpq documentation: 33.19. PQerrorMessage](https://www.postgresql.org/docs/current/libpq-status.html#LIBPQ-PQERRORMESSAGE) for details.

**Returns**

- `errmsg:string`: error message.


## pid = connection:backend_pid()

get the process ID (PID) of the backend server process for this connection.

see [libpq documentation: 33.20. PQbackendPID](https://www.postgresql.org/docs/current/libpq-status.html#LIBPQ-PQBACKENDPID) for details.

**Returns**

- `pid:integer`: backend PID.


## encoding = connection:client_encoding()

get the client encoding.

see [libpq documentation: 34.11. PQclientEncoding](https://www.postgresql.org/docs/current/libpq-control.html#LIBPQ-PQCLIENTENCODING) for details.

**Returns**

- `encoding:string`: the encoding name.


## ok = connection:ssl_in_use()

check whether the connection is using SSL.

see [libpq documentation: 34.2. PQsslInUse](https://www.postgresql.org/docs/current/libpq-status.html#LIBPQ-PQSSLINUSE) for details.

**Returns**

- `ok:boolean`: `true` if the connection is using SSL.


## attr = connection:ssl_attribute( name )

get the SSL attribute.

see [libpq documentation: 34.2. PQsslAttribute](https://www.postgresql.org/docs/current/libpq-status.html#LIBPQ-PQSSLATTRIBUTE) for details.

**Parameters**

- `name:string`: the attribute name.

**Returns**

- `attr:string`: the attribute value.


## names = connection:ssl_attribute_names()

get the SSL attribute names.

see [libpq documentation: 34.2. PQsslAttributeNames](https://www.postgresql.org/docs/current/libpq-status.html#LIBPQ-PQSSLATTRIBUTENAMES) for details.

**Returns**

- `names:string[]`: the attribute names.


## connection:set_notice_receiver( callback )

set the notice receiver callback.

see [libpq documentation: 34.13. Notice Processing](https://www.postgresql.org/docs/current/libpq-notice-processing.html) for details.

**Parameters**

- `callback:function( result:postgres.pgresult )`: The callback function that called for each notice message with the following arguments:
        - `result:postgres.pgresult`: the `postgres.pgresult` object.


## ok = connection:call_notice_receiver( result )

call the notice receiver callback.

**Parameters**

- `result:postgres.pgresult`: the `postgres.pgresult` object.

**Returns**

- `ok:boolean`: `true` if the notice receiver callback was called.


## old = connection:trace( new )

enables tracing of the client/server communication to a debugging file stream.

see [libpq documentation: 34.11. PQtrace](https://www.postgresql.org/docs/current/libpq-control.html#LIBPQ-PQTRACE) for details.

**Parameters**

- `new:file*`: the file stream to write the trace to.

**Returns**

- `old:file*`: the previous file stream.


## old = connection:untrace()

disables tracing of the client/server communication to a debugging file stream.

see [libpq documentation: 34.11. PQuntrace](https://www.postgresql.org/docs/current/libpq-control.html#LIBPQ-PQUNTRACE) for details.

**Returns**

- `old:file*`: the previous file stream.


## ok, err, timeout = connection:flush( [sec] )

attempts to flush any queued output data to the server.

see [libpq documentation: 34.4. PQflush](https://www.postgresql.org/docs/current/libpq-async.html#LIBPQ-PQFLUSH) for details.

**Parameters**

- `sec:number`: the maximum time to wait for the flush to occur in seconds.

**Returns**

- `ok:boolean`: `true` if the data was flushed.
- `err:any`: the error object.
- `timeout:boolean`: `true` if the operation would block.


## qry, err, params = connection:replace_named_params( qry, params )

converts a named parameter `${NAME}` in an SQL query to a positional parameter `$<digit>` and returns the converted SQL query and parameter array.

**Parameters**

- `qry:string`: the SQL query.
- `params:table`: the parameters.

**Returns**

- `qry:string`: the SQL query with the named parameters replaced with the corresponding values.
- `err:any`: the error object.
- `params:table`: the parameters.

**Example**

```lua
local dump = require('dump')
local conn = require('postgres.connection').new()
local qry, err, params = conn:replace_named_params([[
    SELECT
        *
    FROM
        users
    WHERE
        name = ${name}
    AND
        age in (${age})
]], {
    name = "John",
    age = {
        20,
        30,
    },
})

print(qry)
-- SELECT
--     *
-- FROM
--     users
-- WHERE
--     name = $1
-- AND
--     age in ($2, $3)

print(dump(params))
-- {
--     [1] = "John",
--     [2] = "20",
--     [3] = "30"
-- }
```


## res, err, timeout = connection:query( qry [, params [, sec]] )

executes an SQL query and returns the result.  
before executing the query, the named parameters in the query are replaced with positional parameters with `connection:replace_named_params()` method.

**Parameters**

- `qry:string`: the SQL query.
- `params:table`: the parameters.
- `sec:number`: the maximum time to wait for the query to complete in seconds.

**Returns**

- `res:postgres.result`: the `postgres.result` object.
- `err:any`: the error object.
- `timeout:boolean`: `true` if the operation would block.


## res, err, timeout = connection:get_result( [sec] )

waits for the next result from a prior query call, and returns it. A `nil` is returned when the command is complete and there will be no more results.

**Parameters**

- `sec:number`: the maximum time to wait for the query to complete in seconds.

**Returns**

- `res:postgres.result`: the `postgres.result` object.
- `err:any`: the error object.
- `timeout:boolean`: `true` if the operation would block.

